<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>纳甲卦</title>
<script src="jquery.min.js"></script>
<script src="calendar.js"></script>
<script src="unicode.js"></script>
<script src="bible.js"></script>
<link rel="stylesheet" href="octate.css">
</head>
<body>
<table class="hexagram">
  <tr>
    <td colspan="4" class="date"><span></span><span></span></td>
  </tr>

  <tr>
    <td class="names origin"><span class="prefix"></span><span class="name">乾</span><span class="wuxing"></span></td>
    <td class="names self"><span class="prefix"></span><span class="name">乾</span><span class="wuxing"></span></td>
    <td class="change">之</td>
    <td class="names other"><span class="prefix"></span><span class="name">乾</span></td>
  </tr>
  <tr>
    <td class="origin gram up"></td>
    <td class="self gram up"></td>
    <td class="mark">　</td>
    <td class="other gram up"></td>
  </tr>
  <tr>
    <td class="origin gram up"></td>
    <td class="self gram up"></td>
    <td class="mark">　</td>
    <td class="other gram up"></td>
  </tr>
  <tr>
    <td class="origin gram up"></td>
    <td class="self gram up"></td>
    <td class="mark">　</td>
    <td class="other gram up"></td>
  </tr>
  <tr>
    <td class="origin gram up"></td>
    <td class="self gram up"></td>
    <td class="mark">　</td>
    <td class="other gram up"></td>
  </tr>
  <tr>
    <td class="origin gram up"></td>
    <td class="self gram up"></td>
    <td class="mark">　</td>
    <td class="other gram up"></td>
  </tr>
  <tr>
    <td class="origin gram up"></td>
    <td class="self gram up"></td>
    <td class="mark">　</td>
    <td class="other gram up"></td>
  </tr>
</table>

<p class="sep self">
  <span class="hide link">链接</span>
  <span class="hide origin">本卦</span>
  <span class="hide other on">变卦</span>
</p>
<table class="bible self">
  <tr><td class="prepend diagram"></td></tr>
  <tr><td class="prepend title"></td></tr>
  <tr><td class="prepend tuan"></td></tr>
  <tr><td class="prepend xiang"></td></tr>
  <tr>
    <td>
      <table class="grid">
        <tr><th class="nobreak">爻位</th><th>爻辞</th><th>象辞</th></tr>
        <tr><td class="row 5 num"></td><td class="row 5 title"></td><td class="row 5 xiang"></td></tr>
        <tr><td class="row 4 num"></td><td class="row 4 title"></td><td class="row 4 xiang"></td></tr>
        <tr><td class="row 3 num"></td><td class="row 3 title"></td><td class="row 3 xiang"></td></tr>
        <tr><td class="row 2 num"></td><td class="row 2 title"></td><td class="row 2 xiang"></td></tr>
        <tr><td class="row 1 num"></td><td class="row 1 title"></td><td class="row 1 xiang"></td></tr>
        <tr><td class="row 0 num"></td><td class="row 0 title"></td><td class="row 0 xiang"></td></tr>
      </table>
    </td>
  </tr>
</table>

<p class="sep other"></p>
<table class="bible other">
  <tr><td class="prepend diagram"></td></tr>
  <tr><td class="prepend title"></td></tr>
  <tr><td class="prepend tuan"></td></tr>
  <tr><td class="prepend xiang"></td></tr>
  <tr>
    <td>
      <table class="grid">
        <tr><th class="nobreak">爻位</th><th>爻辞</th><th>象辞</th></tr>
        <tr><td class="row 5 num"></td><td class="row 5 title"></td><td class="row 5 xiang"></td></tr>
        <tr><td class="row 4 num"></td><td class="row 4 title"></td><td class="row 4 xiang"></td></tr>
        <tr><td class="row 3 num"></td><td class="row 3 title"></td><td class="row 3 xiang"></td></tr>
        <tr><td class="row 2 num"></td><td class="row 2 title"></td><td class="row 2 xiang"></td></tr>
        <tr><td class="row 1 num"></td><td class="row 1 title"></td><td class="row 1 xiang"></td></tr>
        <tr><td class="row 0 num"></td><td class="row 0 title"></td><td class="row 0 xiang"></td></tr>
      </table>
    </td>
  </tr>
</table>

<script>
function find_content(cat, idx) {
  $(`.bible.${cat} td`).each(function(){
    if(!$(this).hasClass('prepend')) return;
    $(this).text(BIBLE[idx][this.className.replace('prepend ', '')]);
  });
  $.each(BIBLE[idx].table, function(idx, ele){
    $(`.bible.${cat} .row.${idx}.num`).text(ele[0]);
    $(`.bible.${cat} .row.${idx}.title`).text(ele[1]);
    $(`.bible.${cat} .row.${idx}.xiang`).text(ele[2]);
  });
}

function find_gram(cat, pos, up, down, sum) {
  var wuxing;
  if(cat == 'self') {
    wuxing = MAP[pos[0]][2];
    $('.wuxing').text(wuxing);
    let self = pos[1];
    if(self > 5) self -= 4;
    else if(self) self = 6 - self;
    let other = (self + 3) % 6;
    $('.mark').removeClass('on').text('　');
    $('.mark').eq(self).addClass('on').text('世');
    $('.mark').eq(other).addClass('on').text('应');
  } else {
    wuxing = $('.wuxing').text();
  }
  wuxing = WUXING.indexOf(wuxing);
  let data = MAP[up].slice(3, 6).concat(MAP[down].slice(6));
  $.each(data, function(idx, item){
    if(sum !== undefined) {
      var bit = 2**(5-idx);
      $(`.${cat}.gram`).eq(idx).removeClass('up').removeClass('down')
        .addClass((sum& bit)==bit ? 'down' : 'up');
    }
    let attr = WUXING.indexOf(DIZHI[item.substr(1)]);
    if(attr == wuxing) prefix = '兄弟';
    else if(attr == (wuxing + 1) % 5) prefix = '子孙';
    else if(attr == (wuxing + 5 - 1) % 5) prefix = '父母';
    else if(attr == (wuxing + 2) % 5) prefix = '妻财';
    else if(attr == (wuxing + 5 - 2) % 5) prefix = '官鬼';
    $(`.${cat}.gram`).eq(idx).html(`<span>${prefix}</span><span>　</span><span>${item}</span>`);
    var self = $('.self.gram').eq(idx), other = $('.other.gram').eq(idx);
    if(self.hasClass('up') && other.hasClass('up') || self.hasClass('down') && other.hasClass('down'))
      other.addClass('opaque');
    else
      other.removeClass('opaque');
  });
}

var FOUND = {
  self: 0,
  other: 0,
};
function find_names(cat, clazz, current) {
  let sum = 0, names = $('.names.' + cat);
  if(cat == 'origin') {
    sum = HEXAGRAM[ORDER[clazz]]
    names.find('.name').text(MAP[sum[0]][0]);
    names.find('.prefix').text(CHANGE[sum[1]]);
    find_gram(cat, sum, sum[0], sum[0]);
  } else if(!isNaN(clazz)) {
    names.find('.name').text(ORDER[clazz]);
    sum = clazz;
    let down = sum % 8, up = Math.floor(sum / 8);
    if(up == down) names.find('.prefix').text('');
    else names.find('.prefix').text(`${MAP[up][1]}${MAP[down][1]}`);
    find_gram(cat, HEXAGRAM[ORDER[sum]], up, down, sum);
    find_content(cat, sum);
    FOUND[cat] = sum;
    return sum;
  } else {
    $(`td.gram.${cat}`).each(function(idx, ele){
      var bit = $(ele).hasClass('up') ? 0 : 1;
      var weight = 6 - (idx % 6) - 1;
      sum += 2**weight * bit;
      if(ele == current && cat == 'self')
        $('td.gram.other').eq(idx)
          .removeClass('up').removeClass('down').addClass(clazz);
    });
    names.find('.name').text(ORDER[sum]);
    let down = sum % 8, up = Math.floor(sum / 8);
    if(up == down) names.find('.prefix').text('');
    else names.find('.prefix').text(`${MAP[up][1]}${MAP[down][1]}`);
    find_gram(cat, HEXAGRAM[ORDER[sum]], up, down);
    find_content(cat, sum);
    FOUND[cat] = sum;
    return sum;
  }
}
var lunar = calendar.solar2lunar();
$('.date span:first-child').text(`${lunar.lYear}年${lunar.IMonthCn+lunar.IDayCn}，${lunar.gzYear}年${lunar.gzMonth}月${lunar.gzDay}日(${lunar.gzXun}空)`);

$('.gram:not(.origin)').click(function(){
  let clazz = 'up';
  if($(this).hasClass('up')) clazz = 'down';
  $(this).removeClass('up').removeClass('down').addClass(clazz);
  let cat = $(this).hasClass('self') ? 'self' : 'other';
  let found = find_names(cat, clazz, this);
  find_names(cat == 'self' ? 'other' : 'self', clazz, this);
  if(cat == 'self')
    find_names('origin', found, this);
});

$('.hide.other').click(function(){
  $(this).toggleClass('on');
  $('.sep.other').toggle();
  $('.bible.other').toggle();
  $('td.other').css('visibility', $('td.other').css('visibility') == 'visible' ? 'hidden' : 'visible');
  $('.change').css('visibility', $('.change').css('visibility') == 'visible' ? 'hidden' : 'visible');
});
$('.hide.origin').click(function(){
  $(this).toggleClass('on');
  $('td.self').toggle();
  $('td.origin').toggle();
});
$('.hexagram tr').click(function(){
  $(this).addClass('on');
});
$('.hide.link').click(function(){
  var url = location.href.split('?')[0] + `?${FOUND.self},${FOUND.other}`;

	if (navigator.clipboard && window.isSecureContext) {
			navigator.clipboard.writeText(url);
	} else {
		const textArea = document.createElement("textarea");
		textArea.value = url;
		textArea.style.position = "absolute";
		textArea.style.left = "-999999px";
		document.body.prepend(textArea);
		textArea.select();
		try {
				document.execCommand('copy');
		} catch (error) {
				console.error(error);
		} finally {
				textArea.remove();
		}
	}
  $('.date span:last-child').text('链接已复制').show();
  setTimeout(function(){
    $('.date span:last-child').fadeOut(2000);
  }, 1000);
});
if(location.search) {
  $('.hide.link').addClass('on');
  var found = location.search.substr(1).split(',');
  var ret = find_names('self', parseInt(found[0]));
  find_names('other', parseInt(found[1]));
  find_names('origin', ret);
} else {
  find_names('self', 'up');
  find_names('other', 'up');
  find_names('origin', 0);
}
</script>

</body>
</html>
